dist: trusty
compiler: gcc
if: tag IS blank
addons:
  apt:
    sources:
    - sourceline: deb [arch=amd64] http://storage.googleapis.com/bazel-apt stable
        jdk1.8
      key_url: https://storage.googleapis.com/bazel-apt/doc/apt-key.pub.gpg
    - ubuntu-toolchain-r-test
    packages:
    - bazel
before_script:
- echo 'common --curses no' >> .bazelrc
matrix:
  include:
  - name: "Test: static"
    language: cpp
    script:
    - bazel version
    - ./tools/scripts/ci_checks.sh
    - travis_wait 90 bazel build --config=travis //...
    - travis_wait 90 bazel test --config=travis //...
  - name: "Release: static for osx"
    os: osx
    osx_image: xcode9.3 # we want jdk 1.8, bazel doesn't support the newer one that ships with 9.4+
    script:
    - brew install bazel
    - travis_wait 90 bazel build main:sorbet --config=release-mac
    - cp bazel-bin/main/sorbet bin/sorbet-typechecker
    - gem build sorbet.gemspec
    # eventually we'll have gem versions but for now erase them
    - mv sorbet-0.0.1-x86_64-darwin-16.gem sorbet-x86_64-darwin-16.gem
  - name: "Release: static for linux"
    language: cpp
    script:
    - travis_wait 90 bazel build main:sorbet --config=release-linux
    - cp bazel-bin/main/sorbet bin/sorbet-typechecker
    - chmod u+w bin/sorbet-typechecker
    - strip bin/sorbet-typechecker
    - chmod u-w bin/sorbet-typechecker
    - gem build sorbet.gemspec
    # eventually we'll have gem versions but for now erase them
    - mv sorbet-0.0.1-x86_64-linux.gem sorbet-x86_64-linux.gem
  - name: "Test: runtime on Ruby 2.4 & Release"
    language: ruby
    rvm: 2.4
    gemfile: runtime/Gemfile
    script:
    - cd runtime
    - rake test
    - gem build sorbet-runtime.gemspec
    - mv sorbet-runtime-*.gem sorbet-runtime.gem
    - cd .. # cd above breaks deploy step
  - name: "Test: rbi-generation on Ruby 2.4 & Release"
    language: ruby
    rvm: 2.4
    gemfile: rbi-generation/Gemfile
    script:
    - cd rbi-generation
    - gem build sorbet-rbi-generation.gemspec
    - mv sorbet-rbi-generation-*.gem sorbet-rbi-generation.gem
    - cd .. # cd above breaks deploy step
  - name: "Test: runtime on Ruby 2.5"
    language: ruby
    rvm: 2.5
    gemfile: runtime/Gemfile
    script: cd runtime && rake test
  - name: "Test: runtime on Ruby 2.6"
    language: ruby
    rvm: 2.6
    gemfile: runtime/Gemfile
    script: cd runtime && rake test
